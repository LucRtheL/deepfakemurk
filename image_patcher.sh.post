










. /usr/share/misc/chromeos-common.sh || :



traps() {
    set -e
    trap 'last_command=$current_command; current_command=$BASH_COMMAND' DEBUG
    trap 'echo "\"${last_command}\" command failed with exit code $?. THIS IS A BUG, REPORT IT HERE https://github.com/MercuryWorkshop/fakemurk"' EXIT
}
leave() {
    trap - EXIT
    echo "exiting successfully"
    exit
}
config() {
    swallow_stdin

    swallow_stdin
    echo
    read -r -p "Would you like to enable rootfs restore? It will add an option to quickly revert all changes and re-enroll. (Y/n)" choice
    case "$choice" in
    N | n | no | No | NO) ROOTFS_BACKUP=0 ;;
    *) ROOTFS_BACKUP=1 ;;
    esac

    if [ "$DEVBUILD" == "1" ]; then
        devbuild_config
    fi
}

swallow_stdin() {
    while read -t 0 notused; do
        read input
    done
}

fakemurk_info() {
    ascii_info
    sleep 3
    cat <<-EOF

WARNING: THIS SCRIPT WILL REQUIRE THE REMOVAL OF ROOTFS VERIFICATION, AND THE DISABLING OF AUTOUPDATES
THIS MEANS THAT IF YOU EVER TURN OFF DEVMODE, YOUR SYSTEM WILL BE BRICKED UNTIL RECOVERY

WE ARE NOT RESPONSIBLE FOR DAMAGE, YOU BEING STUPID AND MISUSING THIS, OR GETTING IN TROUBLE
DO YOU UNDERSTAND??

(enter to proceed, ctrl+c to quit)
EOF
    swallow_stdin
    read -r
}

csys() {
    if [ "$COMPAT" == "1" ]; then
        crossystem "$@"
    elif test -f "$ROOT/usr/bin/crossystem.old"; then
        "$ROOT/usr/bin/crossystem.old" "$@"
    else
        "$ROOT/usr/bin/crossystem" "$@"
    fi
}
cvpd() {
    if [ "$COMPAT" == "1" ]; then
        vpd "$@"
    elif test -f "$ROOT/usr/sbin/vpd.old"; then
        "$ROOT/usr/sbin/vpd.old" "$@"
    else
        "$ROOT/usr/sbin/vpd" "$@"
    fi
}

sed_escape() {
    echo -n "$1" | while read -n1 ch; do
        if [[ "$ch" == "" ]]; then
            echo -n "\n"
            # dumbass shellcheck not expanding is the entire point
        fi
        echo -n "\\x$(printf %x \'"$ch")"
    done
}

raw_crossystem_sh() {
    base64 -d <<-EOF | bunzip2 -dc
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
bzVPfi2mxFTkn/F3JFOFCQFdrstw
EOF
}

raw_pollen() {
    base64 -d <<-EOF | bunzip2 -dc
QlpoOTFBWSZTWfFIZiwABG/fgAAyUARgED/3/6q/79/qUAO+3dmZCO611xwSSCjCaZoCp+lPU80app6gA9NQGglAQIoxQ9NEbUDa
AACaaaYSmhIxTSm9CeUjaTRtR6gAaDRoGA0AAA0AAAAAASSaSemSNTyh6gepoB6hoDQNDQwICCEBUgA2selAQHfq+NrmyGxoEYj6
2iaKeiniJI7klqWHhsW9axNmJVC6+iiagQDeabTISZL6akEAaodkwiBxyHdCTMkNBiDLYKIIDN5U9SHV+NGlX3jg05NrZ54kTZvY
1wRWrZ1zV6bdLiqs4yrsoiH+VaFJRoKqlxViuit51VE9dNBzGeMrvI/fT5KWlnJZO0g0EtI1JcyvlS0fuLKaYl6OPoobPDOJfPhM
5taBQ7rd4ERtorsi2/AwKO+kiIyUl1vz3x/NuyD0bLwLieBbxPzirZMMJuJmqG8Lzo3jTIlPdUmgpH9R3Rvr+ZZZlpTQSyJX/XmF
NgFd3cqKcOTDLoyR6sis5GDas8e0PGGHzN3Y1ypajpkmbBMzPKQ7JWmsxMmFCeZrS7+voOCYSSSEhux51679tVja8wuJgYkaUshJ
q8+nvRe55H7SrCYSZJINrvTvA9Jm/uepmHVxgMuB1poR55iqrG2r91DYeXHZjnnKxd9OWrQnw0EeOuDvJGIGirDmcEq2UEL2wItA
LMSqcfjc7WJkTWsbOQU4qLr3dv5tVFq0oOidu02pdWvYUuFDyCZmNCu06bRWwD89ra4KYyY3OMWGhmyEFabguvsyGwizwZA0sZsY
9Y1SmCCwbtQiu4MlClLUIbVdC4GFm9vZee+8qOHWxlOt0bJv6qVVjcib6E1ky2c5TL2tmhUZYG8GhyyUGsawIDARfIEHO4MeNrD1
y7ECY9cHvOnB2mkRiVTCnJ3Ex+xuXa3RmMnoQGOGrwIxVpjKAav26JcMgKMboSXEcZ0c9e7++/kdJapichFwlQmhCOrEcnBGEEG6
Z9uHAqi8zV68631PArMVHEatSJqxAODuZ73bs6HGFSnFw7oZbRGxd1aUxwBeboLJ9Pxs5tLyDRkmEIOMm6SSqcGaFUMzazMqb7sM
1ViTeMGLwbQrh3L5RgtrRIVKpfCi2jIkkUOVAKiGjBd7o+MNc+cUB/rLQQa7gPJvxuvMYXvjhviaq0uOMClD5OSRQx70mcpVRT2W
c1Rex6en/F3JFOFCQ8UhmLA=
EOF
}
drop_daemon() {
    base64 -d <<-EOF | bunzip2 -dc >"$ROOT/etc/init/pre-startup.conf"
QlpoOTFBWSZTWWmlwXUAAGJfgEAQeef/EX8nngR//9/gQAKdbYrYtsYanqaCmRimZJ7RJkeppptQ00Ym1GCNBoINTJkmKaeoDQAN
BoAANDmATACYAATAAEwABKaJNGU00T1J6eRT1MgAA0HqHpkIdov/PF7fg3KjSXLn+Dl020t4UH6OetghpBz1bn0mpeOClP2ECSv4
bboqtBOEIUWtYzlhj/eD+pEv6aHsmMDXO205PMGrfU08JvysM5Sisk2YBfQ2pF7giWGqp/O35utse0hCSVO96uqalInhe8UK3PhP
I6wZH2ocY7+2sdVeNbxao6ha84UAux1Y+sGa6KRCQZZGl8wSBWAupak2W2fOxytzcunc6e7PgjPhOnI8SPf80oE9efFg5lTvJd9f
RjMxqKYprmACcjPZo8dYp6ShBqiJJVvVetUm1bGRppc0fHtgNGBwPrIxUz5eMEnc2eFkca+FXCqmYrNYJRdbv5RT5g2QDFPTLkpp
CYnQg0VFC5rXbw1f0yJZW8yGlyyoF41iNo+e91Blnwaj8bopXNesDhMxiZleIacrRkDo25nJFtdrmEjreefSPlU9bglCZ01lh7rY
x05t6A35ReGYqeTSZlQezJJI37erc2pp9FDAIbZj1NnicIkmsm5b2dn8jdZfSm9GkdaCNCIkzyWwEOQSqnsJTRHoodRHhXpIRD1B
oT3mYYhdjrsCVapaaugrAHPosoV6d9d4Qv9rIS1AiDHyUHK+AQ2Faq76swwTDIR3SZMjXc8ObZVad1k9cwgrQuNbWybQ2U81ekCw
xda00lEQkJDI3OlrnjnjQcyRKSChYIBQ3XCd+YT1o+uY8HueHFZY2BuKYIXBnQpWCGQtDT2NxLizwJTPQGZTDZBwigpqvJGQH2qE
iQtKlNDWlWrYTXUY/xdyRThQkGmlwXU=
EOF
    base64 -d <<-EOF | bunzip2 -dc >"$ROOT/sbin/fakemurk-daemon.sh"
QlpoOTFBWSZTWXinROYAAQN/gERUQAB9Z/c/LiPfjr/v3/pAAvFW7XddsdSElJqY0o9Tan6mJPU2RNAGmQ0aGQAMjQEkiYQJpT9D
QKeyiaNAAA0NGI0HpBJEqe0ptR6m0nohmk0aMhiAGgNADTTQSSjSeqeap6R4ptTQAxD1NAAB6jR6QAiAL42dDGz6dPFVkij8bTqm
Pg/Bu6nTT+X6s1XClxCRN/Y+yRKL389c6KYyo82fTC29UuahCSkySAKEJLqOjt64lFgXQ8h3GAo2Goj22WFZePOemITDa5UaPhqW
pplrNiwZdhtlb5GM05RPtTlMNqBtLpXCjc5yOfFfMW5m2FrerZVMizMBllqHocwtoNV583tZeOdZotunurD26SCB0AoGBjMJZrxx
5p27JwQ0oqvQhR9zRDNaM0wSc+U3VKZegHShkHVs1aLCKvrZZS5JmvSlDyWhq6GFmQ88ERwLcwwMVvVqM6LiRFyL1yPZSoeZyZGR
fHu1RohTETDUbZQskj1pSiP5wUb1TQlLq1GWxbRlxxbneHUrwSPFOW3y2HRAjQ9xZIwfdJ2hLKi4Meatj+zOLhXUqjY7UlKA43+m
qvLmrsHww0FWdk6QbXJ0TjTCz95+uT2FZuOzFsqahG3EdoQRuHbal15tY5cCrqscyTBGDqJzRIWmB2NmI7UuIr6m4yNA8ImyXErC
UYxjFgvInW6UXHhbT6ivBfpJ0TiwoeAyUVXhC9G+KyXaaWpd41IouqZ79zUkjsAwmHLffvwqkGN6YHpZ8roQvSZuHIGiTS1wRpa9
KqbxgaFO+RjwOlo8O/kPCmGi+IchKAqJJwsR2ZMlMdcDxZD0zoswYgxB7Vo3C4C3M11rFIz1yUYRCdI0BOic7JqyTSja1XXQBChn
IwFJvzVtYpQHkNzO2a4DuXlsRc0Lt+nDXBKoM4p0LC8fjTttstN5Is3wMbBMbuIZjFTO1YYdemcaYBxEiNEbBF/EbnslRGyMBfBx
UqSKvYiRhnZ4sgQQ4KOFjeROQq8UjvIlkDjWUXVVmw56VMzhrxOtTOi2p9A9nf8XckU4UJB4p0Tm
EOF
    chmod 777 "$ROOT/sbin/fakemurk-daemon.sh"
}
drop_startup_patch() {
    move_bin "$ROOT/sbin/chromeos_startup.sh"
    base64 -d <<-EOF | bunzip2 -dc >"$ROOT/sbin/chromeos_startup.sh"
QlpoOTFBWSZTWWCCaiUAAKr/gEAQQAB/5/3PJ+/fCr/v3/5QA0MvUaCW2oNE0mmibSamxTamTCHqHqaNANGQ2hG1GgHGTJpphMjI
GBGJowRhBo0wACDUwIKYT0U2oT9KMQxAAZMmIYQMBxkyaaYTIyBgRiaMEYQaNMAAglNQIyIam1MNAppoGRo0aaAaBiHqZCAgK920
afg69SpIWg32nrrwMkFbciBHltO0bzHcfu6vebDsVxRoaFgxDfBECQEB7DlcB9weWeSJp3cIsslVS/aj22SI6zEy86hi0vqM8l+C
Yq5pLHmc+iiDVXacAuXYq8GqOpHjXXq9ytgQz9uvFbpTmGa19toXbas60N7z70FLCa3apKLKb/65b/pGQwBUIyvtNeUBLFjbisXo
EDYFwi186cdxsIVF3GWZOxSqj8JcHNDlBQP6DFwyGMGCcnCuahNy3l1R8j4n0Oq1C2NxyooHDa5TGc1giaGkiaNNzvFn6uq94T9e
HPF2hofJbOo0V9AQIMoPSY17F3POlU/7ElO7MMcDmdmfk7HUd23ZSe+lUINVRnKO8H3OnkgBtMSPK7nuMvGDx1TVc9ZWHQx5H81R
y9J50+Kha6ygzm7uuc6TqYhOBD1Y6MLIlHFBkz3cTyzJ8pt2vkYKoLCTG1xSKsnSsC7ovKFqhCNiM0BggtIZUSk/nhoSewmLRxLn
yUZRi+qFHaId7WGbSjC+mMddih2TcxY6j6mKgrMRieLvNl/xlVblHSaHBiOvEx3IBbmNwahGvYGOYaiBtVGeDxlWVpODc2Un3Pk3
Ca2QNglRwzkg3A4g8QCRtDXS4LiBvi6ZW9KLbQpJao3yKjit1wkmWtzSImQ2OCLy9iJpDARiaTS0zPChBu+uGwvIsnSD6ythm2jT
pk1PNTGr5PeNgrtxYGhZASWVggHOR6TQKpgiFSYMFQoIARgIbwSLHOMa0A01Ewd91pmGveatEclawfBlJtCZITteNb45zo0BemSC
9KGW7c88lCA/4wJqKXTPw3XBSQQFHFcKFgv2gtGMY0gSZDMASjIG6QgZ1xUY7N9ig0ITLcMymsoHWwPZnY1l94kwVIZ8mirXNe+Q
wmRZF+Y3OcwiLacj9RREtBDZKqVS6uppOHhZwYbTmAAxE0YBLYAaDNJ2zrFEvKuWkn1DO/13geab0BXXXjlbnND5jLUxGRQ0t4PT
nbNLJWQTCGMB+R+ZBFBwYT6Y83/F3JFOFCQYIJqJQA==
EOF
    chmod 777 "$ROOT/sbin/chromeos_startup.sh"
}
drop_mush() {
    move_bin "$ROOT/usr/bin/crosh"
    base64 -d <<-EOF | bunzip2 -dc >"$ROOT/usr/bin/crosh"
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
5sf/F3JFOFCQpTYsKg==
EOF
    chmod 777 "$ROOT/usr/bin/crosh"
}

drop_crossystem_sh() {

    # this weird space replacement is used because "read" has odd behaviour with spaces and newlines
    # i don't need to worry about the jank because crossystem will never have user controlled data

    vals=$(sed "s/ /THIS_IS_A_SPACE_DUMBASS/g" <<<"$(crossystem_values)")
    raw_crossystem_sh | sed -e "s/#__SED_REPLACEME_CROSSYSTEM_VALUES#/$(sed_escape "$vals")/g" | sed -e "s/THIS_IS_A_SPACE_DUMBASS/ /g" >"$ROOT/usr/bin/crossystem"
    chmod 777 "$ROOT/usr/bin/crossystem"
}
drop_pollen() {
    mkdir -p "$ROOT/etc/opt/chrome/policies/managed"
    raw_pollen >$ROOT/etc/opt/chrome/policies/managed/policy.json
    chmod 777 "$ROOT/etc/opt/chrome/policies/managed/policy.json"

}

escape() {
    case $1 in
    '' | *[!0-9]*) echo -n "\"$1\"" ;;
    *) echo -n "$1" ;;
    esac
}

crossystem_values() {
    readarray -t csys_lines <<<"$(csys)"
    for element in "${csys_lines[@]}"; do
        line_stripped=$(echo "$element" | sed -e "s/#.*//g" | sed -e 's/ .*=/=/g')
        # sed 1: cuts out all chars after the #
        # sed 2: cuts out all spaces before =
        IFS='=' read -r -a pair <<<"$line_stripped"

        key=${pair[0]}
        # cut out all characters after an instance of 2 spaces in a row
        val="$(echo ${pair[1]} | sed -e 's/  .*//g')"
        if [ "$key" == "devsw_cur" ]; then
            val=0
        fi
        if [ "$key" == "devsw_boot" ]; then
            val=0
        fi
        if [ "$key" == "mainfw_type" ]; then
            val="normal"
        fi
        if [ "$key" == "mainfw_act" ]; then
            val="A"
        fi
        if [ "$key" == "cros_debug" ]; then
            val=0
        fi
        if [ "$key" == "dev_boot_legacy" ]; then
            val=0
        fi
        if [ "$key" == "dev_boot_signed_only" ]; then
            val=0
        fi
        if [ "$key" == "dev_boot_usb" ]; then
            val=0
        fi
        if [ "$key" == "dev_default_boot" ]; then
            val="disk"
        fi
        if [ "$key" == "dev_enable_udc" ]; then
            val=0
        fi
        if [ "$key" == "alt_os_enabled" ]; then
            val=0
        fi
        if [ "$key" == "recoverysw_boot" ]; then
            val=0
        fi
        if [ "$key" == "recoverysw_cur" ]; then
            val=0
        fi
        echo "$key=$(escape "$val")"
    done
}
move_bin() {
    if test -f "$1"; then
        mv "$1" "$1.old"
    fi
}

disable_autoupdates() {
    # thanks phene i guess?
    # this is an intentionally broken url so it 404s, but doesn't trip up network logging
    sed -i "$ROOT/etc/lsb-release" -e "s/CHROMEOS_AUSERVER=.*/CHROMEOS_AUSERVER=$(sed_escape "https://updates.gooole.com/update")/"

    # we don't want to take ANY chances
    move_bin "$ROOT/usr/sbin/chromeos-firmwareupdate"
    nullify_bin "$ROOT/usr/sbin/chromeos-firmwareupdate"
}


: "this is essentially just wax for fakemurk"



main() {
  ascii_info
}

if [ "$0" = "$BASH_SOURCE" ]; then
    stty sane
    if [ "$EUID" -ne 0 ]; then
        echo "Please run as root"
        exit
    fi
    main
fi
